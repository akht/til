# 正規表現

## 第1回
↓ターゲットの文字列
```
名前：伊藤淳一
電話：03-1234-5678
電話：090-1234-5678
電話：0795-12-3456
電話：04992-1-2345
電話：03(1234)5678
電話：090-1234-5678
電話：0795(12)3456
電話：04992-1-2345
住所：兵庫県西脇市板波町1-2-3
```

#### 数字にマッチ
`\d` (`[0-9]`と同じ)


#### 01-2345-6789みたいな並びの数字にマッチ
`\d\d-\d\d\d\d-\d\d\d\d`


#### 数字の数に幅を持たせてマッチ
``\d{2,5}-\d{1,4}-\d{4}``

{n,m}や[n]といった量指定氏で、数字の数を指定する。
※{n,m}は「直前の文字がn個以上、m個以下」という意味。
　{n}は「ちょうどn文字」という意味。


#### 括弧を使った電話番号にマッチ
`\d{2,5}[-(]\d{1,4}[-)]\d{4}`

「半角数字が2個～5個、ハイフンまたはカッコ（開き）、半角数字が1個～4個、ハイフンまたはカッコ（閉じ）、半角数字が4個」

「AまたはBのいずれか1文字」を表す場合は`[AB]`と書く。
`[ABC]`と書けば、「AまたはBまたはCのいずれか1文字」の意味。
※「­ハイフンまたはカッコ」は`[-(]`と表している。

##### []のなかのハイフンは特別な意味を持つ
`[a-z]`と書くと「aまたはbまたはcまたは・・・yまたはz」の意味になる。
`[a-zA-Z0-9]`と書くと、「半角英数字1文字」の意味になる。
つまり、先頭・末尾以外のハイフンは範囲を表すメタ文字として解釈される。


## 第2回
↓ターゲットの文字列
```
クープバゲットのパンは美味しかった。
今日はクープ バゲットさんに行きました。
クープ　バゲットのパンは最高。
ジャムおじさんのパン、ジャムが入ってた。
また行きたいです。クープ・バゲット。
クープ・バケットのパン、売り切れだった（><）
```

#### いろんな区切り文字を許容する
`クープ[ 　・]バゲット` ([]のなかは半角スペースと全角スペースと中黒)

「クープ」と「バゲット」の区切りに、半角スペースだったり全角スペースだったり中黒だったりが使われているので
これらすべてのパターンにマッチさせる。


#### 濁点の有無を許容する
`クープ[ 　・]バ[ケゲ]ット`

`[]`を使う。


#### 区切り文字の有無を許容する
`クープ[ 　・]?バ[ケゲ]ット`

「～が1文字、または無し」を表現するためには`?`というメタ文字を使う(量指定子)

#### 区切り文字を簡易的に指定する
`クープ.?バ[ケゲ]ット`

`[ 　・]`の部分は、現実的には「任意の1文字」で十分。
「任意の1文字」を表すには`.`というメタ文字を使う。


### HTMLタグをCSVへ変換する
↓ターゲットの文字列
```
<select name="game_console">
<option value="none"></option>
<option value="wii_u" selected>Wii U</option>
<option value="ps4">プレステ4</option>
<option value="gb">ゲームボーイ</option>
</select>
```

selectタグの中身をCSVに変換したいとする。↓のような結果が欲しい。

```
wii_u,Wii U
ps4,プレステ4
gb,ゲームボーイ
```

#### valueを抜き出す正規表現を考える
valueはこんな感じのパターンになっている。
「value=、ダブルクオート、英数字またはアンダースコアが1文字以上、ダブルクオート」

「直前の文字が**1文字以上**」を表すのは'+'というメタ文字。
「英数字またはアンダースコア」は`[a-z0-9_]`。

よって`value="[a-z0-9_]+"`


#### 表示テキストを抜き出す正規表現を考える
`>.+<`

「>ではじまり、何かしらの文字が続き、<で終わる」


#### CSV形式にする
1. 行全体にマッチする正規表現を作る
1. valueと表示テキストの部分をそれぞれ()で囲ってキャプチャする
1. キャプチャを利用ｓ知恵新しい文字列を組み立てる


##### 1. 行全体にマッチする正規表現を作る
`<option value="[a-z0-9_]+">.+<\/option>`

※optionの前のスラッシュをエスケープしている
　スラッシュを使った正規表現リテラルを持っていないものはエスケープ

##### 2. valueと表示テキストの部分をそれぞれ()で囲ってキャプチャする
valueと表示テキストをそれぞれ()で囲む。

`<option value="([a-z0-9_]+)">(.+)<\/option>`

すると、()のなかみがキャプチャされ、連番がつけられる。
キャプチャされた部分は`$1`や`$2`といった番号でアクセスできる。


#### 表示テキストがない場合に対応

`<option value="none"></option>`には表示テキストがないので
`<option value="([a-z0-9_]+)">(.+)<\/option>`ではマッチしない。

なぜなら`.+`の部分で、「任意の文字が**１文字以上**」としているから。
ここを`*`を使って「任意の文字が0文字以上」と修正する。

`<option value="([a-z0-9_]+)">(.*)<\/option>`


#### selectedになっているoptionも置換できるようにする

optionタグのどれかひとつが選択状態になっている(selected属性が付いている)場合。

正規表現に「selectedがあり、または無し」というOR条件を追加する。

`A?`のような正規表現は「Ａが1文字、または無し」の意味だったが、
`?`は2文字以上の文字列に対しても「あり、なし」として使える。
その場合は対象文字列を()で囲む(グループ化)
`(XYZ)?`と書くと、「文字列XYZがある、または無い」の意味になる。

`<option value="([a-z0-9_]+)"( selected)?>(.*)<\/option>`

が、こう書いてしまうと、不要な`( selected)`の部分までキャプチャされてしまい、
`$1`や`$2`でアクセスしていたものがずれてしまう。
なので、()でグループ化する場合にキャプチャが不要な箇所は`(?:)`とする。

`<option value="([a-z0-9_]+)"(?: selected)?>(.*)<\/option>`



#### ちょっと洗練させる

`<option value="([a-z0-9_]+)"(?: selected)?>(.*)<\/option>`を他の表現

##### `[0-9]`を`\d`に置き換える
半角数字を表すメタ文字`\d`で`[0-9]`を置き換える。
(`\d`は`[]`のなかで使える)

`<option value="([a-z0-9_]+)"(?: selected)?>(.*)<\/option>`
↓
`<option value="([a-z\d_]+)"(?: selected)?>(.*)<\/option>`


#### `[a-z\d_]`を`\w`に置き換える
「英単語を構成する文字」という意味の`\w`というメタ文字がある。
これで`[a-z\d_]`を置き換える(厳密には`\w`を使うと大文字アルファベットもマッチする)

`<option value="([a-z\d_]+)"(?: selected)?>(.*)<\/option>`
↓
`<option value="(\w+)"(?: selected)?>(.*)<\/option>`




###  * と + は「貪欲」であることに注意
```
<option value="ps4">プレステ4</option><option value="gb">ゲームボーイ</option>
```
たとえば、↑のテキストを`<option value="(\w+)"(?: selected)?>(.*)<\/option>`を使って検索すると、

マッチグループはこのようになる
```
1. ps4
2. プレステ4</option><option value="gb">ゲームボーイ
```

問題は、`>(.*)<`の部分。
これは、「>で始まり、任意の文字が0個以上連続し、<で終わる」なので、途中にでてくる「<」も任意の文字として扱われてしまう。

このように`+`と`*`は貪欲に最長のマッチを結果として返す。
これを避けるためには、以下のように書き直す。

#### `任意の1文字`よりも厳しい条件を指定する
`任意の1文字`という緩い条件を少し厳しくして、`<以外の任意の1文字`とする。

「Ａ以外の任意の文字」を表したいときは`[^A]`と書く。
`[]`の最初に`^`が入ると否定の意味に変わる。
`[^AB]`であれば、「ＡでもなくＢでもない任意の1文字」という意味になる。

よって「<以外の任意の文字」は`[^<]`で表す。
これを使って正規表現を書き直すと↓になる。
`<option value="(\w+)"(?: selected)?>([^<])<\/option>`

#### 最短のマッチを返すように指定する
`+`や`*`の貪欲さをなくして最短マッチを返すように指定する。

`>(.*)<`は厳密には「>で始まり、任意の文字が0個以上連続し、最後に見つかった<で終わる」という意味になる。
これを、「>で始まり、任意の文字が0個以上連続し、最初に見つかった<で終わる」と変える。

そのためには`>(.*?)<`のように`?`をつける。
`*?`や`+?`にすると、最長ではなく、最短のマッチを結果として返すようになる。(最小量指定子と呼ぶ)

これを使って正規表現を書き直すと↓になる。
`<option value="(\w+)"(?: selected)?>(.*?)<\/option>`



#### まとめ

- `?`は「直前の文字が1個、または無し」を表す
- `.`は「任意の1文字」を表す
- `+`は「直前の文字が1個以上」を表す
- `*`は「直前の文字が0個以上」を表す
- `()`はマッチする部分をキャプチャする
- キャプチャした部分は置換するときに`$1`や`$2`で参照できる
- `\w`は「英単語を構成する文字(半角英数字とアンダースコア)」を表す
- `[^AB]`は「AでもなくBでもない任意の1文字」を表す
- 正規表現中の特別な文字は`\`でエスケープする
- `()` はキャプチャだけでなく、グループ化にも使われる
- `(ABC)?` は「文字列 ABC があり、または無し」を表す
- `(?:)`はキャプチャ無しでグループ化する場合に使う
- `*`と`+`は「貪欲」で最長マッチ
- `*?`や`+?`にすると、最短マッチを返す





#####
